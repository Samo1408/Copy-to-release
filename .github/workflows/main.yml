name: Upload Large Files to Release
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  upload-to-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download large file from external source
        run: |
          echo "ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø«Ù‚ÙŠÙ„..."
          curl -L -o large-file.zip "https://netix.dl.sourceforge.net/project/mystic-gsi-updates/Generic/Foxos-BLUEFOX_NX1-15-2025_20250829-AB-20250908-MysticGSI.zip?viasf=1"
          echo "âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­"
          
      - name: Check file size
        run: |
          FILE_SIZE=$(stat -f%z large-file.zip 2>/dev/null || stat -c%s large-file.zip 2>/dev/null || echo "0")
          echo "ğŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $((FILE_SIZE / 1024 / 1024)) MB"
          
      - name: Split large file if needed
        run: |
          FILE_SIZE=$(stat -f%z large-file.zip 2>/dev/null || stat -c%s large-file.zip 2>/dev/null || echo "0")
          MAX_SIZE=2147483648
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "âœ‚ï¸ Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† 2GBØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…..."
            split -b 1500M large-file.zip large-file-part-
            echo "âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
            ls -la large-file-part-*
          else
            echo "ğŸ“¦ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù†Ø§Ø³Ø¨ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªÙ‚Ø³ÙŠÙ…"
          fi
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release ${{ github.run_number }} - Large Files
          draft: false
          prerelease: false
          commitish: ${{ github.sha }}
          
      - name: Upload assets
        run: |
          FILE_SIZE=$(stat -f%z large-file.zip 2>/dev/null || stat -c%s large-file.zip 2>/dev/null || echo "0")
          MAX_SIZE=2147483648
          UPLOAD_URL="${{ steps.create_release.outputs.upload_url }}"
          
          # Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø§Ø¨Ø· - Ø¥Ø²Ø§Ù„Ø© {?name,label}
          UPLOAD_URL=$(echo $UPLOAD_URL | sed 's/{.*}//')
          echo "ğŸ”— Upload URL: $UPLOAD_URL"
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø³Ù…Ø©..."
            for part in large-file-part-*; do
              PART_NUMBER=$(echo $part | sed 's/large-file-part-//')
              echo "Ø±ÙØ¹ Ø§Ù„Ø¬Ø²Ø¡: $part"
              
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/zip" \
                -H "Accept: application/vnd.github.v3+json" \
                --data-binary @"$part" \
                "$UPLOAD_URL?name=large-file-part-${PART_NUMBER}.zip"
            done
          else
            echo "ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„..."
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/zip" \
              -H "Accept: application/vnd.github.v3+json" \
              --data-binary @large-file.zip \
              "$UPLOAD_URL?name=large-file.zip"
          fi
          
      - name: Create and upload reassembly script
        run: |
          UPLOAD_URL=$(echo "${{ steps.create_release.outputs.upload_url }}" | sed 's/{.*}//')
          
          cat > reassemble-files.sh << 'EOF'
          #!/bin/bash
          echo "ğŸ”§ Ø³ÙƒØ±Ù¾Øª Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡"
          
          if ls large-file-part-*.zip 1> /dev/null 2>&1; then
            echo "Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡..."
            cat large-file-part-*.zip > large-file-reassembled.zip
            echo "âœ… ØªÙ… Ø¬Ù…Ø¹ Ø§Ù„Ù…Ù„Ù: large-file-reassembled.zip"
            echo "Ù„Ù„ØªØ­Ù‚Ù‚: unzip -t large-file-reassembled.zip"
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ù„Ù"
          fi
          EOF
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: text/x-shellscript" \
            -H "Accept: application/vnd.github.v3+json" \
            --data-binary @reassemble-files.sh \
            "$UPLOAD_URL?name=reassemble-files.sh"
            
      - name: Create and upload instructions
        run: |
          UPLOAD_URL=$(echo "${{ steps.create_release.outputs.upload_url }}" | sed 's/{.*}//')
          
          cat > INSTRUCTIONS.md << 'EOF'
          # ğŸ“š ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
          
          ## Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…Ù‚Ø³Ù…Ù‹Ø§:
          1. Ø­Ù…Ù„ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ (large-file-part-*.zip)
          2. Ø§Ø­ÙØ¸Ù‡Ù… ÙÙŠ Ù…Ø¬Ù„Ø¯ ÙˆØ§Ø­Ø¯
          3. Ø´ØºÙ„ Ø§Ù„Ø³ÙƒØ±Ù¾Øª: `bash reassemble-files.sh`
          4. Ø£Ùˆ Ø§Ø¬Ù…Ø¹Ù‡Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§: `cat large-file-part-* > large-file.zip`
          
          ## Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„Ù‹Ø§:
          - Ø­Ù…Ù„ large-file.zip Ù…Ø¨Ø§Ø´Ø±Ø©
          
          ## Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù:
          ```bash
          unzip -t large-file.zip
          ```
          EOF
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: text/markdown" \
            -H "Accept: application/vnd.github.v3+json" \
            --data-binary @INSTRUCTIONS.md \
            "$UPLOAD_URL?name=INSTRUCTIONS.md"
            
      - name: Cleanup
        run: |
          rm -f large-file.zip large-file-part-* reassemble-files.sh INSTRUCTIONS.md
          echo "ğŸ§¹ ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"

      - name: Display release info
        run: |
          echo "ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ release Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ“ Ø§Ù„Ø±Ø§Ø¨Ø·: https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
          echo "ğŸ’¾ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† ØµÙØ­Ø© Releases"            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ù„Ù"
          fi
          EOF
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: text/x-shellscript" \
            -H "Accept: application/vnd.github.v3+json" \
            --data-binary @reassemble-files.sh \
            "$UPLOAD_URL?name=reassemble-files.sh"
            
      - name: Create and upload instructions
        run: |
          UPLOAD_URL=$(echo "${{ steps.create_release.outputs.upload_url }}" | sed 's/{.*}//')
          
          cat > INSTRUCTIONS.md << 'EOF'
          # ğŸ“š ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
          
          ## Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…Ù‚Ø³Ù…Ù‹Ø§:
          1. Ø­Ù…Ù„ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ (large-file-part-*.zip)
          2. Ø§Ø­ÙØ¸Ù‡Ù… ÙÙŠ Ù…Ø¬Ù„Ø¯ ÙˆØ§Ø­Ø¯
          3. Ø´ØºÙ„ Ø§Ù„Ø³ÙƒØ±Ù¾Øª: `bash reassemble-files.sh`
          4. Ø£Ùˆ Ø§Ø¬Ù…Ø¹Ù‡Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§: `cat large-file-part-* > large-file.zip`
          
          ## Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„Ù‹Ø§:
          - Ø­Ù…Ù„ large-file.zip Ù…Ø¨Ø§Ø´Ø±Ø©
          
          ## Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù:
          ```bash
          unzip -t large-file.zip
          ```
          EOF
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: text/markdown" \
            -H "Accept: application/vnd.github.v3+json" \
            --data-binary @INSTRUCTIONS.md \
            "$UPLOAD_URL?name=INSTRUCTIONS.md"
            
      - name: Cleanup
        run: |
          rm -f large-file.zip large-file-part-* reassemble-files.sh INSTRUCTIONS.md
          echo "ğŸ§¹ ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"

      - name: Display release info
        run: |
          echo "ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ release Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ“ Ø§Ù„Ø±Ø§Ø¨Ø·: https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}"          EOF
          
          # Ø±ÙØ¹ Ø³ÙƒØ±Ù¾Øª Ø§Ù„Ø¬Ù…Ø¹
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: text/x-shellscript" \
            -H "Accept: application/vnd.github.v3+json" \
            -T "reassemble-files.sh" \
            "${{ steps.create_release.outputs.upload_url }}?name=reassemble-files.sh"
            
      - name: Create instructions file
        run: |
          cat > INSTRUCTIONS.md << 'EOF'
          # ğŸ“š ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
          
          ## Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…Ù‚Ø³Ù…Ù‹Ø§:
          1. Ø­Ù…Ù„ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ (large-file-part-*.zip)
          2. Ø§Ø­ÙØ¸Ù‡Ù… ÙÙŠ Ù…Ø¬Ù„Ø¯ ÙˆØ§Ø­Ø¯
          3. Ø´ØºÙ„ Ø§Ù„Ø³ÙƒØ±Ù¾Øª: `bash reassemble-files.sh`
          4. Ø£Ùˆ Ø§Ø¬Ù…Ø¹Ù‡Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§: `cat large-file-part-* > large-file.zip`
          
          ## Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„Ù‹Ø§:
          - Ø­Ù…Ù„ large-file.zip Ù…Ø¨Ø§Ø´Ø±Ø©
          
          ## Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù:
          ```bash
          unzip -t large-file.zip
          ```
          EOF
          
          # Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: text/markdown" \
            -H "Accept: application/vnd.github.v3+json" \
            -T "INSTRUCTIONS.md" \
            "${{ steps.create_release.outputs.upload_url }}?name=INSTRUCTIONS.md"
            
      - name: Cleanup
        run: |
          rm -f large-file.zip large-file-part-* reassemble-files.sh INSTRUCTIONS.md
          echo "ğŸ§¹ ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"

      - name: Display release info
        run: |
          echo "ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ release Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ“ Ø§Ù„Ø±Ø§Ø¨Ø·: https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
          echo "ğŸ’¾ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† ØµÙØ­Ø© Releases"
