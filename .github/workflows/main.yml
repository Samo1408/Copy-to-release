name: Upload Large Files to Release
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  upload-to-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download large file from external source
        run: |
          echo "ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø«Ù‚ÙŠÙ„..."
          # ØºÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
          curl -L -o large-file.zip "https://master.dl.sourceforge.net/project/mystic-gsi-updates/Generic/Oxygenos-OP5D55L1-16-1744797430944-AB-20250915-MysticGSI.zip?viasf=1"
          echo "âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­"
          
      - name: Check file size
        run: |
          FILE_SIZE=$(stat -f%z large-file.zip 2>/dev/null || stat -c%s large-file.zip 2>/dev/null || echo "0")
          echo "ğŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $((FILE_SIZE / 1024 / 1024)) MB"
          
      - name: Split large file if needed
        run: |
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
          FILE_SIZE=$(stat -f%z large-file.zip 2>/dev/null || stat -c%s large-file.zip 2>/dev/null || echo "0")
          MAX_SIZE=2147483648  # 2GB in bytes
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "âœ‚ï¸ Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† 2GBØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…..."
            # ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ù„Ù Ù„Ø£Ø¬Ø²Ø§Ø¡ 1.5GB (1500MB) Ù„ÙƒÙ„ Ø¬Ø²Ø¡
            split -b 1500M large-file.zip large-file-part-
            echo "âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
            ls -la large-file-part-*
          else
            echo "ğŸ“¦ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù†Ø§Ø³Ø¨ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªÙ‚Ø³ÙŠÙ…"
          fi
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release ${{ github.run_number }} - Large Files
          draft: false
          prerelease: false
          commitish: ${{ github.sha }}
          
      - name: Upload assets based on file size
        run: |
          FILE_SIZE=$(stat -f%z large-file.zip 2>/dev/null || stat -c%s large-file.zip 2>/dev/null || echo "0")
          MAX_SIZE=2147483648
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø³Ù…Ø©..."
            # Ø±ÙØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø³Ù…Ø©
            for part in large-file-part-*; do
              PART_NUMBER=$(echo $part | sed 's/large-file-part-//')
              echo "Ø±ÙØ¹ Ø§Ù„Ø¬Ø²Ø¡: $part"
              
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/zip" \
                -H "Accept: application/vnd.github.v3+json" \
                -T "$part" \
                "${{ steps.create_release.outputs.upload_url }}?name=large-file-part-${PART_NUMBER}.zip"
            done
          else
            echo "ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„..."
            # Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† 2GB
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/zip" \
              -H "Accept: application/vnd.github.v3+json" \
              -T "large-file.zip" \
              "${{ steps.create_release.outputs.upload_url }}?name=large-file.zip"
          fi
          
      - name: Create reassembly script
        run: |
          cat > reassemble-files.sh << 'EOF'
          #!/bin/bash
          # Ø³ÙƒØ±Ù¾Øª Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
          echo "ğŸ”§ Ø³ÙƒØ±Ù¾Øª Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡"
          
          if ls large-file-part-*.zip 1> /dev/null 2>&1; then
            echo "Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡..."
            cat large-file-part-*.zip > large-file-reassembled.zip
            echo "âœ… ØªÙ… Ø¬Ù…Ø¹ Ø§Ù„Ù…Ù„Ù: large-file-reassembled.zip"
            echo "ÙŠÙ…ÙƒÙ†Ùƒ ÙØ­Øµ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: unzip -t large-file-reassembled.zip"
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ù„Ù"
          fi
          EOF
          
          # Ø±ÙØ¹ Ø³ÙƒØ±Ù¾Øª Ø§Ù„Ø¬Ù…Ø¹
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: text/x-shellscript" \
            -H "Accept: application/vnd.github.v3+json" \
            -T "reassemble-files.sh" \
            "${{ steps.create_release.outputs.upload_url }}?name=reassemble-files.sh"
            
      - name: Create instructions file
        run: |
          cat > INSTRUCTIONS.md << 'EOF'
          # ğŸ“š ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
          
          ## Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…Ù‚Ø³Ù…Ù‹Ø§:
          1. Ø­Ù…Ù„ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ (large-file-part-*.zip)
          2. Ø§Ø­ÙØ¸Ù‡Ù… ÙÙŠ Ù…Ø¬Ù„Ø¯ ÙˆØ§Ø­Ø¯
          3. Ø´ØºÙ„ Ø§Ù„Ø³ÙƒØ±Ù¾Øª: `bash reassemble-files.sh`
          4. Ø£Ùˆ Ø§Ø¬Ù…Ø¹Ù‡Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§: `cat large-file-part-* > large-file.zip`
          
          ## Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„Ù‹Ø§:
          - Ø­Ù…Ù„ large-file.zip Ù…Ø¨Ø§Ø´Ø±Ø©
          
          ## Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù:
          ```bash
          unzip -t large-file.zip
          ```
          EOF
          
          # Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: text/markdown" \
            -H "Accept: application/vnd.github.v3+json" \
            -T "INSTRUCTIONS.md" \
            "${{ steps.create_release.outputs.upload_url }}?name=INSTRUCTIONS.md"
            
      - name: Cleanup
        run: |
          rm -f large-file.zip large-file-part-* reassemble-files.sh INSTRUCTIONS.md
          echo "ğŸ§¹ ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"

      - name: Display release info
        run: |
          echo "ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ release Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ“ Ø§Ù„Ø±Ø§Ø¨Ø·: https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
          echo "ğŸ’¾ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† ØµÙØ­Ø© Releases"
